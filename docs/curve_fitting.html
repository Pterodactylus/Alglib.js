<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>

<h1>Alglib.js Curve Fitting</h1>
<h2>An fitting a cubic equation (or arbitrary function) to a dataset using ALGLIB.js</h2>

<p>
    Suppose that we are given a series of points on a graph and we need to  fit them with a cubic polynomial.
    \[ (x_i,y_i) = [(-3, 8), (1,3), (5,3), (9,8), (10,16)]\]
</p>
<p>
    We want to choose \(a_0\), \(a_1\), \(a_2\) and \(a_3\) so that the function \(f(x)\) is minimized where
    \[f(x) = a_3x^3+a_2x^2+a_1x+a_0\]
</p>
<p>
    To do this we define a least square equations that gives the sum of the squares of the "error" of the function evaluated at all points.
    \[Sum Squared Error = \sqrt{\sum_{i=1}^5 (y_i - f(x_i))^2}\]
</p>
<p>
    In theory this process can be extended to any arbitrary function.
</p>
<canvas id="myChart" height="400" width="800"></canvas>
<script>
const ctx = document.getElementById('myChart').getContext('2d');
const myChart = new Chart(ctx, {
    type: "scatter",
    data: {
        datasets: [
          {
            data: {},
            label: 'Actual',
            showLine: false,
            fill: false,
            borderColor: 'red'
          },
          {
            data: {},
            label: 'Cubic Approximate',
            showLine: true,
            fill: false,
            borderColor: 'blue'
          }
        ]
    },
    options: {
        responsive: false,
        scales: {
            y: {
                beginAtZero: false
            }
        }
    }
});
</script>

<p>
<textarea id="demo" rows="40" cols="170">
</textarea>

<script type="module">
	import {Alglib} from 'https://cdn.jsdelivr.net/gh/Pterodactylus/Alglib.js@master/Alglib-v1.1.0.js'
	//import {Alglib} from '../Alglib-v1.1.0.js'

    var f = function(a_n, x){
        return a_n[3]*Math.pow(x, 3)+a_n[2]*Math.pow(x, 2)+a_n[1]*Math.pow(x, 1)+a_n[0];
    }

    let data = [[-3, 8], [1,3], [5,3], [9,8], [10,16]]
	var fn1 = function(a){
	    let sum = 0
	    for (let i = 0; i < data.length; ++i) {
            sum = sum + Math.pow(data[i][1] - f(a, data[i][0]), 2)
        }
        let sse = Math.sqrt(sum)
        return sse
	}
	
	let solver = new Alglib()
	solver.add_function(fn1) //Add the first equation to the solver.
	
	solver.promise.then(function(result) { 
		var x_guess = [1,1,1,1] //Guess the initial values of the solution.
		var s = solver.solve("min", x_guess) //Solve the equation

        //Update the chart
        let actual_data = []
        let spline_data = []
		let a=solver.get_results()
        for (let i = 0; i < data.length; ++i) {
            actual_data.push({x:data[i][0], y:data[i][1]})
        }
        let x_values = data.map(function(elt) { return elt[0]; });
        let x_min = Math.min.apply(null,x_values)
        let x_max = Math.max.apply(null,x_values)
        let n = 100
        let r = (x_max-x_min)/n
        for (let i = 0; i <= n; ++i) {
            let x = x_min + i * r
            spline_data.push({x:x, y:f(a,x)})
        }
		myChart.data.datasets[0].data = actual_data;
		myChart.data.datasets[1].data = spline_data;
        myChart.update();

		document.getElementById("demo").value = solver.get_report()
		solver.remove() //required to free the memory in C++
	})
</script>
</body>
</html>
